SELECT DSN.DIECUT_ID, DSN.DIECUT_SN, DSN.AGES, DSN.USED,REMAIN, DSN.DIECUT_NEAR_EXP
, CASE WHEN DSN.REMAIN <= 0 THEN '1' WHEN DSN.REMAIN <= DSN.DIECUT_NEAR_EXP THEN '2' ELSE '3' END PRIORITY
, DSN.STATUS, DSN.DIECUT_TYPE, DSN.TL_STATUS, DSN.LAST_MODIFY, DSN.DUE_DATE, DM.MODIFY_TYPE 
FROM (
    SELECT SN.DIECUT_ID, SN.DIECUT_SN, NVL(SN.DIECUT_AGE,0) AGES
    , CASE 
        WHEN NVL(SN.DIECUT_AGE,0) = 0 THEN 0
        WHEN NVL(UD.USED,0) = 0 THEN NVL(SN.DIECUT_AGE,0) 
        ELSE TRUNC(DIECUT_MAX)
        END  
        AS DIECUT_NEAR_EXP
    , NVL(UD.USED,0) USED 
    , CASE 
        WHEN USED IS NULL THEN NVL(SN.DIECUT_AGE,0) 
        WHEN NVL(SN.DIECUT_AGE,0) - NVL(UD.USED,0) <0 THEN 0 
        ELSE NVL(SN.DIECUT_AGE,0) - NVL(UD.USED,0) 
      END REMAIN  
    , SN.STATUS, SN.TL_STATUS, SN.LAST_MODIFY, SN.DUE_DATE
    , SN.DIECUT_TYPE
    FROM KPDBA.DIECUT_SN SN
    LEFT OUTER JOIN  (
        SELECT WD.DIECUT_SN, SUM(WD.COUNTER_QTY ) USED
        FROM KPDBA.WIP_DIECUT WD
        JOIN KPDBA.DIECUT_SN SN ON WD.DIECUT_SN = SN.DIECUT_SN  
        LEFT JOIN (SELECT DIECUT_SN, MAX(RESET_DATE) LAST_MODIFY   FROM KPDBA.DIECUT_RESET_HIST GROUP BY DIECUT_SN) HS ON WD.DIECUT_SN = HS.DIECUT_SN
        WHERE NVL(WD.COUNTER_QTY, 0) > 0   
        AND WD.CR_DATE > NVL(HS.LAST_MODIFY, TO_DATE('01/09/2018','dd/mm/yyyy'))
        GROUP BY WD.DIECUT_SN
    ) UD ON SN.DIECUT_SN = UD.DIECUT_SN
    LEFT JOIN (
        SELECT DIECUT_SN, DIECUT_AGE - ( AVG + (1.96 * (STDDEV / SQRTCOUNTROW)) ) AS DIECUT_MAX 
        FROM (
            SELECT WD.DIECUT_SN, NVL(SN.DIECUT_AGE,0) AS DIECUT_AGE, 
                             SQRT( COUNT (1) OVER (ORDER BY WD.DIECUT_SN)) SQRTCOUNTROW,
                             AVG (COUNTER_QTY) OVER (ORDER BY WD.DIECUT_SN) AVG,
                             STDDEV (COUNTER_QTY) OVER (ORDER BY WD.DIECUT_SN) STDDEV
            FROM KPDBA.WIP_DIECUT WD
            JOIN KPDBA.DIECUT_SN SN ON WD.DIECUT_SN = SN.DIECUT_SN  
            LEFT JOIN (SELECT DIECUT_SN, MAX(RESET_DATE) LAST_MODIFY   FROM KPDBA.DIECUT_RESET_HIST GROUP BY DIECUT_SN) HS ON WD.DIECUT_SN = HS.DIECUT_SN
            WHERE NVL(WD.COUNTER_QTY, 0) > 0   
            AND WD.CR_DATE > NVL(HS.LAST_MODIFY, TO_DATE('01/09/2018','dd/mm/yyyy'))
        )
        GROUP BY DIECUT_SN, ( DIECUT_AGE - ( AVG + (1.96 * (STDDEV / SQRTCOUNTROW)) ) )
    ) NE ON SN.DIECUT_SN = NE.DIECUT_SN
    WHERE NVL(SN.STATUS,'F') <> 'F' AND SN.TL_STATUS = 'GOOD'
) DSN  
LEFT JOIN KPDBA.DIECUT_MODIFY DM ON  (DSN.DIECUT_SN = DM.DIECUT_SN AND DM.END_TIME IS NULL AND DM.CANCEL_FLAG = 'F')
